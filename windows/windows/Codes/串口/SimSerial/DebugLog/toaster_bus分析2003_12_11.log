toaster & virtual device 驱动打印日志分析
周长志
2003年12月11日

================ Thu Dec 11 22:33:13 2003
NTICE: Using I/O Apic at linear address FFD06000
NTICE: Pentium TSC calibration, processor set to 1533.0 MHZ
Windows NT Version 5.0 - Build 2195 (Free) SP 6F00
NTICE: PS2 mouse detected
NTICE: LPT1 = Port: 0378
.........
加载总线驱动Toaster bus driver
设备类型是System

-------DriverEntry  build on Dec 11 2003 22:09:42
BusEnum.SYS: Add Device: 0x82094c30
BusEnum.SYS: AddDevice: 81c003d0 to 82094c30->82094c30 (\Device\00528)
BusEnum.SYS: FDO IRP_MN_QUERY_LEGACY_BUS_INFORMATION IRP:0x8206bbe8
BusEnum.SYS: FDO IRP_MN_FILTER_RESOURCE_REQUIREMENTS IRP:0x8206bbe8

NTICE: Load32 START=BEA0A000  SIZE=11820  KPEB=820A09A0  MOD=SCSIPORT

BusEnum.SYS: FDO IRP_MN_START_DEVICE IRP:0x81b0e2a8
BusEnum.SYS: FDO IRP_MN_QUERY_CAPABILITIES IRP:0x81b0e2a8
BusEnum.SYS: FDO IRP_MN_QUERY_PNP_DEVICE_STATE IRP:0x81b0e2a8
BusEnum.SYS: FDO IRP_MN_QUERY_DEVICE_RELATIONS IRP:0x81b0e2a8
        QueryDeviceRelation Type: BusRelations
        #PDOS present = 0
        #PDOs reported = 0

NTICE: Load32 START=EB6B0000  SIZE=4A80  KPEB=820A09A0  MOD=FLPYDISK

BusEnum.SYS: FDO: IRP_MN_REGINFO
。。。。。

运行enum程序，enum -p 1
总线驱动程序虚拟生成一个PDO，指明总线设备失效，迫使OS重新发出命令枚举总线设备
注意下面打印语句中IRP的对象PDO和FDO的区别

BusEnum.SYS: Create
BusEnum.SYS: PlugIn called
PlugInSize:  46
BUSENUM_PLUGIN_HARDWARE:   8
BusEnum.SYS: Exposing PDO
======SerialNo:   1
======HardwareId:     Toaster\MsToaster
======Length:         19
BusEnum.SYS: FdoData->NextLowerDriver = 0x82094c30
BusEnum.SYS: FDO IRP_MN_QUERY_DEVICE_RELATIONS IRP:0x81756a48
        QueryDeviceRelation Type: BusRelations
        #PDOS present = 1
        #PDOs reported = 1
BusEnum.SYS: PDO IRP_MN_QUERY_ID IRP: 0x81764ec8
        QueryId Type: BusQueryDeviceID
BusEnum.SYS: PDO IRP_MN_QUERY_CAPABILITIES IRP: 0x81764ec8
Zcz:  targetObject:  81c003d0
BusEnum.SYS: FDO IRP_MN_QUERY_CAPABILITIES IRP:0x81756a48
BusEnum.SYS: PDO IRP_MN_QUERY_DEVICE_TEXT IRP: 0x81764ec8
        DeviceTextDescription :Microsoft_Eliyas_Toaster_01
BusEnum.SYS: PDO IRP_MN_QUERY_DEVICE_TEXT IRP: 0x81764ec8
        DeviceTextLocationInformation: Unknown
BusEnum.SYS: PDO IRP_MN_QUERY_ID IRP: 0x81764ec8
        QueryId Type: BusQueryInstanceID
        InstanceID: 01
BusEnum.SYS: PDO IRP_MN_QUERY_ID IRP: 0x81764ec8
        QueryId Type: BusQueryHardwareIDs
BusEnum.SYS: PDO IRP_MN_QUERY_ID IRP: 0x81764ec8
        QueryId Type: BusQueryCompatibleIDs
BusEnum.SYS: PDO IRP_MN_QUERY_RESOURCE_REQUIREMENTS IRP: 0x81764ec8
BusEnum.SYS: PDO IRP_MN_QUERY_BUS_INFORMATION IRP: 0x81764ec8
BusEnum.SYS: PDO IRP_MN_QUERY_RESOURCES IRP: 0x81764ec8
BusEnum.SYS: Close

NTICE: Exit32 PID=2BC  MOD=Enum
NTICE: Load32 START=76920000  SIZE=1B000  KPEB=81720880  MOD=sfc
NTICE: Load32 START=67720000  SIZE=F7000  KPEB=81720880  MOD=sfcfiles

BusEnum.SYS: PDO IRP_MN_QUERY_ID IRP: 0x81764ec8
        QueryId Type: BusQueryDeviceID
BusEnum.SYS: PDO IRP_MN_QUERY_CAPABILITIES IRP: 0x81764ec8
Zcz:  targetObject:  81c003d0
BusEnum.SYS: FDO IRP_MN_QUERY_CAPABILITIES IRP:0x81750288
BusEnum.SYS: PDO IRP_MN_QUERY_DEVICE_TEXT IRP: 0x81764ec8
        DeviceTextDescription :Microsoft_Eliyas_Toaster_01
BusEnum.SYS: PDO IRP_MN_QUERY_DEVICE_TEXT IRP: 0x81764ec8
        DeviceTextLocationInformation: Unknown
BusEnum.SYS: PDO IRP_MN_QUERY_ID IRP: 0x81764ec8
        QueryId Type: BusQueryInstanceID
        InstanceID: 01
BusEnum.SYS: PDO IRP_MN_QUERY_ID IRP: 0x81764ec8
        QueryId Type: BusQueryHardwareIDs
BusEnum.SYS: PDO IRP_MN_QUERY_ID IRP: 0x81764ec8
        QueryId Type: BusQueryCompatibleIDs
BusEnum.SYS: PDO IRP_MN_QUERY_RESOURCE_REQUIREMENTS IRP: 0x81764ec8
BusEnum.SYS: PDO IRP_MN_QUERY_BUS_INFORMATION IRP: 0x81764ec8
BusEnum.SYS: PDO IRP_MN_QUERY_RESOURCES IRP: 0x81764ec8
NTICE: Load32 START=EB800000  SIZE=4C20  KPEB=820A09A0  MOD=SISERIAL

虚拟串口程序开始加载
Serial.sys: -----------WDMSample   Build on Dec 11 2003 22:03:19   ---------------
Serial.sys: Enter SerialCreateDevObj
Serial.sys: DeviceName:
Serial.sys: ----------- \Device\VSerial5
Serial.sys: pDevExt->DeviceName.MaximumLength :  34
Serial.sys: Leave SerialCreateDevObj
Serial.sys: AddDevice PDO (0x8174d5b0) FDO (0x816aa880)
Serial.sys: AddDevice: 816aa880 to 8174d5b0->8174d5b0
Serial.sys: Sample IRP_MN_????? IRP:0x81750288

BusEnum.SYS: PDO IRP_MN_QUERY_LEGACY_BUS_INFORMATION IRP: 0x81750288
Serial.sys: Sample IRP_MN_FILTER_RESOURCE_REQUIREMENTS IRP:0x81750288
BusEnum.SYS: PDO IRP_MN_FILTER_RESOURCE_REQUIREMENTS IRP: 0x81750288
Serial.sys: Sample IRP_MN_QUERY_INTERFACE IRP:0x81750288
BusEnum.SYS: PDO IRP_MN_QUERY_INTERFACE IRP: 0x81750288
BusEnum.SYS: FDO IRP_MN_QUERY_INTERFACE IRP:0x81750288
BusEnum.SYS: FDO IRP_MN_QUERY_INTERFACE IRP:0x81750288
Serial.sys: Sample IRP_MN_START_DEVICE IRP:0x81750288
BusEnum.SYS: PDO IRP_MN_START_DEVICE IRP: 0x81750288
Serial.sys: Enter SerialdoExternalNaming routine...
Serial.sys: linkName.Length   32
Serial.sys: SERIAL:  DosName is COM5
Serial.sys: SymbolicLinkName:  \DosDevices\COM5
DeviceName:   \Device\VSerial5
Serial.sys: Create the symbolic link OK
Serial.sys: Sample IRP_MN_QUERY_CAPABILITIES IRP:0x81750288
BusEnum.SYS: PDO IRP_MN_QUERY_CAPABILITIES IRP: 0x81750288
Zcz:  targetObject:  81c003d0
BusEnum.SYS: FDO IRP_MN_QUERY_CAPABILITIES IRP:0x816b2e68
Serial.sys: Sample IRP_MN_QUERY_PNP_DEVICE_STATE IRP:0x81750288
BusEnum.SYS: PDO IRP_MN_QUERY_PNP_DEVICE_STATE IRP: 0x81750288
Serial.sys: Sample IRP_MN_QUERY_DEVICE_RELATIONS IRP:0x81750288
BusEnum.SYS: PDO IRP_MN_QUERY_DEVICE_RELATIONS IRP: 0x81750288
        QueryDeviceRelation Type: BusRelations
Zcz:  PDO:  QueryDeviceRelation
NTICE: Load32 START=1000000  SIZE=5000  KPEB=816AE540  MOD=runonce
NTICE: Load32 START=77F80000  SIZE=79000  KPEB=816AE540  MOD=ntdll


运行enum，enum -u 1 卸载虚拟串口设备

BusEnum.SYS: Create
BusEnum.SYS: UnPlug called
BusEnum.SYS: Plugging out 1
BusEnum.SYS: found device 1
BusEnum.SYS: Plugged out 1
BusEnum.SYS: FDO IRP_MN_QUERY_DEVICE_RELATIONS IRP:0x816ab9a8
        QueryDeviceRelation Type: BusRelations
        #PDOS present = 1
        #PDOs reported = 0
Serial.sys: Sample IRP_MN_QUERY_DEVICE_RELATIONS IRP:0x816ab9a8
BusEnum.SYS: PDO IRP_MN_QUERY_DEVICE_RELATIONS IRP: 0x816ab9a8
        QueryDeviceRelation Type: RemovalRelations
Zcz:  PDO:  QueryDeviceRelation
Serial.sys: Sample IRP_MN_QUERY_DEVICE_RELATIONS IRP:0x816ab9a8
BusEnum.SYS: PDO IRP_MN_QUERY_DEVICE_RELATIONS IRP: 0x816ab9a8
        QueryDeviceRelation Type: EjectionRelations
Zcz:  PDO:  QueryDeviceRelation
Serial.sys: Sample IRP_MN_SURPRISE_REMOVAL IRP:0x816ab9a8
BusEnum.SYS: PDO IRP_MN_SURPRISE_REMOVAL IRP: 0x816ab9a8
Serial.sys: Sample IRP_MN_REMOVE_DEVICE IRP:0x816ab9a8
Serial.sys: +Enter RemoveDevice routine
Serial.sys: SERIAL: Enter SerialRemoveDevObj
Serial.sys: SERIAL: Leave SerialRemoveDevObj
BusEnum.SYS: PDO IRP_MN_REMOVE_DEVICE IRP: 0x816ab9a8
        Deleting PDO: 0x8174d5b0
Serial.sys: NextLowerDriver:  0x8174d5b0
Serial.sys: -Exit RemoveDevice routine
Serial.sys: Is unloading......
Serial.sys: Unload:  unload
NTICE: Unload32 MOD=SISERIAL
BusEnum.SYS: FDO IRP_MN_QUERY_DEVICE_RELATIONS IRP:0x816ab9a8
        QueryDeviceRelation Type: BusRelations
        #PDOS present = 0
        #PDOs reported = 0
BusEnum.SYS: Close
NTICE: Exit32 PID=3AC  MOD=Enum

卸载toaster总线驱动
NTICE: Load32 START=67720000  SIZE=F7000  KPEB=816E1160  MOD=sfcfiles
BusEnum.SYS: FDO IRP_MN_QUERY_DEVICE_RELATIONS IRP:0x816ab9a8
        QueryDeviceRelation Type: RemovalRelations
BusEnum.SYS: FDO IRP_MN_QUERY_REMOVE_DEVICE IRP:0x816ab9a8
BusEnum.SYS: FDO IRP_MN_REMOVE_DEVICE IRP:0x816ab9a8
        Deleting FDO: 0x81c003d0
BusEnum.SYS: Unload

--- the end  ---
