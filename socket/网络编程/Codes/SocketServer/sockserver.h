#if !defined SOCKSREVER_H
#define SOCKSERVER_H

#define LISTENS						5		//????????????
#define FILE_MAX_PATH				512		//?t?@?C????p?X?????
#define FILE_NAME_SIZE				20		//?t?@?C?????????
#define DATA_BUFSIZE				4096	//?t?@?C?????????????????
#define NEXT_RECV_NEW_SOCK			0		//?\?P?b?g?????????0    //???????????
#define NEXT_RECV_FST_PACK			1		//?\?P?b?g?????????1    //???????????
#define NEXT_RECV_FILE_NAME			2		//?\?P?b?g?????????2    //???????????
#define NEXT_RECV_FILE_CONTENT		3		//?\?P?b?g?????????3    //???????????

#define SUCC_FLAG					'S'		//?????
#define FAIL_FLAG					'F'		//???s?W??

typedef unsigned long uLong;

typedef struct SS_UploadFstPack
{
	uLong lSum;							//?t?@?C??????v
	char szFolder[FILE_MAX_PATH];		//?f?B???N?g????t?@?C????b?v???[?h
	uLong lPad;							//?p?f?B???O
}SH_UploadFstPack;

typedef struct SS_FileInfoPack
{
	uLong lSize;						//?t?@?C???????
	char szName[FILE_NAME_SIZE];		//?t?@?C????
	uLong lPad;							//?p?f?B???O
}SH_FileInfoPack;

typedef struct SS_UploadRec
{
	HANDLE hFile;						//?t?@?C????n???h??
	uLong lWritten;						//?????t?@?C?????????b?v???[?h????
	SH_FileInfoPack FileInfo;			//?t?@?C???˜é
}SH_UploadRec;

typedef struct SS_SockGuarder
{
	int iSock;							//?\?P?b?g
	int iStatus;						//?\?P?b?g????
	int iCount;							//?t?@?C????J?E???^?[??b?v???[?h????	SH_UploadFstPack UpFstPack;			//?ãÅ?f?[?^?p?b?N
	SH_UploadRec* pUpRec;				//?t?@?C????A?b?v???[?h??L?^?|?C???^?[
}SH_SockGuarder;


class CSockServer
{
public:
	CSockServer();						//?N???X??\?z???
	virtual ~CSockServer();				//?N???X???\???
	int DoTask( int nPort );			//?T?[?o?[???
protected:
	SH_SockGuarder* pGuarder;			//SS_SockGuarder?\?????|?C???^?[
	int m_nGuarderLen;					//SS_SockGuarder?\????????

	int TCPLoad();						//TCP????[?h
	int InitSock( int nPort );			//?\?P?b?g?????	int InitGuarderArr( int nLen );		//SS_SockGuarder?\?????z??????	int InsertSock( int sock );			//?V?????\?P?b?g??}??
	int PeekRead( int sock, char* buf, int len );		//???????A?????????îY
	int ReadSock( SH_SockGuarder& Guarder );			//?\?P?b?g????
	int RecvUploadFstPack( SH_SockGuarder& Guarder );	//?ãÅ?f?[?^?p?b?N?????	int RecvFileInfoPack( SH_SockGuarder& Guarder );	//?t?@?C???˜é?????	int RecvFileContent( SH_SockGuarder& Guarder );		//?t?@?C?????????	int TCPWrite( int sock, char* buf, int len );		//?\?P?b?g?????
	void ErrorHandler( int nErrFlg, SH_SockGuarder& Guarder );	//?G???[???
	int TCPUnLoad();	//TCP??A?????[?h????	int DeleteFilesInFolder( char* pszFolder );		//?t?H???_??????????t?@?C?????????};

#endif

